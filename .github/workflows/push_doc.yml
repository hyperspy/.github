name: Push Documentation
# To prevent pwn PR requests (for example in PR preview, where documentation is pushed automatically)
# the documentation have to be built in a workflow that doesn't have access to any secrets and
# therefore the build and push workflow needs to be done separetely in two different workflows.
# See https://securitylab.github.com/resources/github-actions-preventing-pwn-requests for more information.

# The caller workflow needs to provide an access token with write access to the repository
# for example:
#   permissions:
#     # needs write permission to push the docs
#     contents: write

on:
  workflow_call:
    inputs:
      artifact_name:
        description: 'The name of the github artifact containing the doc'
        default: 'doc_html'
        type: string
      external_repository:
        description: >
          'The external repository, if not the current repository, for example "hyperspy/hyperspy".
          If used, a personal token with access to the repository is required.'
        default: ''
        type: string
      branch:
        description: 'The branch to push to, for example "gh-pages"'
        default: 'gh-pages'
        type: string
      output_path:
        description: 'The path where the doc will be written'
        default: '.'
        type: string
      redirect_to_version:
        description: 'Add a redirect index.html in the root folder pointing to the given version.'
        default: ''
        type: string
    secrets:
      personal_token:
        description: 'The access token required to push an external repository'

jobs:
  push_doc:
    # This build is to push changes to a repository
    name: Push docs ${{ inputs.branch }}
    runs-on: ubuntu-latest
    env:
      html_folder: doc/_build/html
      redirect_folder: redirect
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ env.html_folder }}

      - name: list files
        run: |
          ls

      - name: Deploy docs
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
        with:
          github_token: ${{ github.token }}
          personal_token: ${{ secrets.personal_token }}
          publish_dir: ${{ env.html_folder }}
          destination_dir: ${{ inputs.output_path }}
          external_repository: ${{ inputs.external_repository }}
          publish_branch: ${{ inputs.branch }}

      - name: Build index redirect
        if: ${{ inputs.redirect_to_version != '' }}
        env:
          VERSION: ${{ inputs.redirect_to_version }}
          FOLDER: ${{ env.redirect_folder }}
        run: |
          mkdir -p ${FOLDER}
          cat <<EOF > ${FOLDER}/index.html
          <!DOCTYPE html>
          <html>
            <head>
              <meta http-equiv="refresh" content="0; url=${VERSION}/">
              <script>window.location.href='${VERSION}/';</script>
            </head>
            <body>
              <p>Redirecting to the <a href="${VERSION}/">documentation (stable)</a>...</p>
            </body>
          </html>
          EOF

      - name: Deploy redirect to versioned docs
        if: ${{ inputs.redirect_to_version != '' }}
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
        with:
          github_token: ${{ github.token }}
          personal_token: ${{ secrets.personal_token }}
          publish_dir: ${{ env.redirect_folder }}
          destination_dir: . # deploy the redirect to the root folder
          external_repository: ${{ inputs.external_repository }}
          publish_branch: ${{ inputs.branch }}
          keep_files: true
