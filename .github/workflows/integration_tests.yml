name: Integration tests

on:
  workflow_call:
    inputs:
      EXTENSIONS:
        description: 'The list of extension to test.'
        default: 'exspy holospy lumispy hyperspy-gui-ipywidgets hyperspy-gui-traitsui'
        type: string
      EXTENSION_VERSION:
        description: 'The version of the extension to test. It can be "release" or "dev".'
        default: 'release'
        type: string
      HYPERSPY_VERSION:
        description: 'The version of the hyperspy to test. It can be "release", "RnM" or "RnP".'
        default: 'release'
        type: string
      ROSETTASCIIO_VERSION:
        description: 'The version of the rosettasciio to test. It can be "release" or "dev".'
        default: 'release'
        type: string
      INSTALL_SOURCE_FROM_REPOSITORY:
        description: 'Whether to install the source code of the current repository.'
        default: true
        type: boolean
      USE_CONDA:
        description: 'Whether to use conda to install the packages. Set to "false" to use pip.'
        default: false
        type: boolean
      ADDITIONAL_PACKAGES:
        description: 'List of additional packages to install.'
        default: ''
        type: string
      NUMBA_DEV:
        description: 'Whether to install the numba development version.'
        default: false
        type: boolean
      DEPENDENCIES_PRE_RELEASE:
        description: 'List of dependencies to install pre-release installed with packages from pypi.org.'
        default: '' # e.g. matplotlib scipy scikit-learn sympy h5py scikit-image numba
        type: string
      DEPENDENCIES_DEV:
        # Dev version from https://anaconda.org/scientific-python-nightly-wheels/
        description: 'List of dependencies to install from scientific-python-nightly-wheels.'
        default: '' # e.g. matplotlib scipy scikit-learn sympy h5py scikit-image 
        type: string
      PLATFORM:
        description: 'The platform to run the tests on.'
        default: 'ubuntu-latest'
        type: string
      PIP_EXTRAS:
        description: 'Optional “variants” (also called extra) to be installed for the source of the current repository'
        # if empty string, no argument is passed
        default: ''
        type: string
      CACHE_POOCH:
        description: |
          'The list of pooch cache to cache - see pooch.os_cache() for more information.'
          'For library using `pooch.retrieve()`, `pooch` needs to be added, because the default pooch cache folder is used.'
        default: 'kikuchipy pyxem'
        type: string
      CACHE_POOCH_LABEL:
        description: 'A label to add to the pooch cache key.'
        default: 'pooch'
        type: string
      PYTEST_ARGS:
        description: 'Additional arguments to pass to pytest.
                      If not provided, defaults to "--reruns 3 -n <number_of_cpus>".'
        default: ''
        type: string
      PYTHON_VERSION:
        description: 'The Python version to use for the tests.'
        default: '3.12'
        type: string
      TEST_DEPS:
        description: 'The test dependencies to install.'
        default: '"pytest<9" pytest-xdist pytest-rerunfailures pytest-instafail pytest-mpl filelock'
        type: string
      LABEL:
        description: 'A label to add to the job name.'
        default: ''
        type: string
      REPORT_FAILURE_AS_ISSUE:
        description: 'Whether to create a GitHub issue from pytest logs on failure. Needs issue write permissions.'
        default: false
        type: boolean

jobs:
  integration_test:
    name: ${{ inputs.PLATFORM }} py${{ inputs.PYTHON_VERSION }} ${{ inputs.LABEL }}
    runs-on: ${{ inputs.PLATFORM }}
    
    defaults:
      run:
        shell: bash -el {0}
    env:
      MPLBACKEND: agg
      PYTEST_ARGS: ${{ inputs.PYTEST_ARGS }}
    steps:
      - uses: actions/checkout@v5
        with: 
          fetch-depth: 0
          fetch-tags: true

      - name: Get repository name
        run: |
          echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Fetch tags upstream
        if: ${{ github.repository_owner != 'hyperspy' }}
        run: |
          git remote add upstream https://github.com/hyperspy/${{ env.REPOSITORY_NAME }}.git
          git fetch upstream --tags

      - uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          python-version: ${{ inputs.PYTHON_VERSION }}
          activate-environment: "test"
          conda-remove-defaults: "true"

      - name: Install pip
        run: |
          conda install pip

      - name: Cache pip
        uses: actions/cache@v4
        env:
          # Increase this value to reset cache
          CACHE_NUMBER: 0
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-integration-pip-${{ env.CACHE_NUMBER }}
          restore-keys: |
            ${{ runner.os }}-integration-pip-${{ env.CACHE_NUMBER }}

      - name: Cache conda
        if: ${{ inputs.USE_CONDA }}
        uses: actions/cache@v4
        env:
          # Increase this value to reset cache
          CACHE_NUMBER: 0
        with:
          path: ~/conda_pkgs_dir
          key:
            ${{ runner.os }}-integration-conda-${{ env.CACHE_NUMBER }}
          restore-keys: |
            ${{ runner.os }}-integration-conda-${{ env.CACHE_NUMBER }}

      - name: Conda info
        run: |
          conda info
          conda list

      - name: Install test dependencies
        run: |
          if [[ "${{ inputs.USE_CONDA }}" == "true" ]]; then
            conda install ${{ inputs.TEST_DEPS }} pytest-reportlog
          else
            pip install ${{ inputs.TEST_DEPS }} pytest-reportlog
          fi

      - name: Install numba development version
        if: ${{ inputs.NUMBA_DEV }}
        run: |
          mamba install -c numba/label/dev numba

      - name: Install dependencies pre-release version
        if: ${{ inputs.DEPENDENCIES_PRE_RELEASE }}
        run: |
          pip install --upgrade --pre ${{ inputs.DEPENDENCIES_PRE_RELEASE }}

      - name: Install dependencies development version
        if: ${{ inputs.DEPENDENCIES_DEV }}
        run: |
          pip install --upgrade --pre --extra-index-url \
          https://pypi.anaconda.org/scientific-python-nightly-wheels/simple \
          ${{ inputs.DEPENDENCIES_DEV }}

      - name: Get the number of CPUs
        id: cpus
        run: |
          import os, platform
          num_cpus = os.cpu_count() - 1 # keep one CPU free for testing multiprocessing
          print(f"Number of CPU: {num_cpus}")
          print(f"Architecture: {platform.machine()}")
          output_file = os.environ["GITHUB_OUTPUT"]
          with open(output_file, "a", encoding="utf-8") as output_stream:
              output_stream.write(f"count={num_cpus}\n")
        shell: python

      - name: Set pytest options
        if: ${{ env.PYTEST_ARGS == '' }}
        run: |
          # it shouldn't be necessary to set `--dist=loadfile` because it should already
          # set as default in the pytest configuration, but it doesn't seem to work...
          if [[ "${{ env.PYTEST_ARGS }}" == "true" ]]; then
            PYTEST_ARGS="--reruns 3 -n ${{ steps.cpus.outputs.count }} --dist=loadfile"
          fi
          PYTEST_LOG_ARGS="--report-log=${{ runner.temp }}/pytest-log.jsonl"
          echo "PYTEST_ARGS=${PYTEST_ARGS}" >> $GITHUB_ENV
          echo "PYTEST_LOG_ARGS=${PYTEST_LOG_ARGS}" >> $GITHUB_ENV

      - name: Install astra-toolbox and test dependencies
        if: ${{ contains(inputs.EXTENSIONS, 'etspy') }}
        run: |
          # astra-toolbox is an etspy dependency
          # install ffmpeg until test is skipped if not installed
          # tomli is needed for `test_version`, it should be possible to remove in the future
          # https://github.com/usnistgov/etspy/issues/24
          conda install astra-toolbox ffmpeg tomli

      - name: Install extensions (release)
        if: ${{ contains(inputs.EXTENSION_VERSION, 'release') }}
        run: |
          if [[ "${{ inputs.USE_CONDA }}" == "true" ]]; then
            libraries="${{ inputs.EXTENSIONS }}"
            # Replace kikuchipy with kikuchipy-base for conda installation
            libraries=$(echo "$libraries" | sed 's/kikuchipy/kikuchipy-base/g')
            echo $libraries
            conda install $libraries
          else
            pip install ${{ inputs.EXTENSIONS }}
          fi

      - name: Install additional packages
        if: ${{ inputs.ADDITIONAL_PACKAGES != '' }}
        run: |
          if [[ "${{ inputs.USE_CONDA }}" == "true" ]]; then
            conda install ${{ inputs.ADDITIONAL_PACKAGES }}
          else
            pip install ${{ inputs.ADDITIONAL_PACKAGES }}
          fi

      - name: Conda list
        run: |
          conda list

      - name: Install HyperSpy (${{ inputs.HYPERSPY_VERSION }})
        if: ${{ env.REPOSITORY_NAME != 'hyperspy' }}
        run: |
          if [[ "${{ inputs.HYPERSPY_VERSION }}" == "release" ]]; then
            if [[ "${{ inputs.USE_CONDA }}" == "true" ]]; then
              conda install hyperspy
            else
              pip install "hyperspy[all]"
            fi
          elif [[ "${{ inputs.HYPERSPY_VERSION }}" == "RnM" ]]; then
            pip install "hyperspy[all] @ git+https://github.com/hyperspy/hyperspy.git@RELEASE_next_minor"
          elif [[ "${{ inputs.HYPERSPY_VERSION }}" == "RnP" ]]; then
            pip install "hyperspy[all] @ git+https://github.com/hyperspy/hyperspy.git@RELEASE_next_patch"
          else
            echo "Unknown HYPERSPY_VERSION: ${{ inputs.HYPERSPY_VERSION }}"
            exit 1
          fi

      - name: Install RosettaSciIO (${{ inputs.ROSETTASCIIO_VERSION }})
        if: ${{ env.REPOSITORY_NAME != 'rosettasciio' }}
        run: |
          if [[ "${{ inputs.ROSETTASCIIO_VERSION }}" == "release" ]]; then
            if [[ "${{ inputs.USE_CONDA }}" == "true" ]]; then
              conda install rosettasciio
            else
              pip install "rosettasciio[all]"
            fi
          elif [[ "${{ inputs.ROSETTASCIIO_VERSION }}" == "dev" ]]; then
            pip install "rosettasciio[all] @ git+https://github.com/hyperspy/rosettasciio.git"
          else
            echo "Unknown ROSETTASCIIO_VERSION: ${{ inputs.ROSETTASCIIO_VERSION }}"
            exit 1
          fi

      - name: Install Extension (dev)
        if: ${{ inputs.EXTENSION_VERSION == 'dev' }}
        run: |
          for ext in $(echo "${{ inputs.EXTENSIONS }}" | tr ' ' '\n'); do
            if [[ "$ext" == "exspy" && "${{ env.REPOSITORY_NAME }}" != "exspy" ]]; then
              # workaround for zenodo rate limits
              # https://github.com/hyperspy/exspy/pull/156
              # pip install "exspy @ git+https://github.com/hyperspy/exspy.git"
              pip install "exspy @ git+https://github.com/ericpre/exspy.git@rate_limit_zenodo"
            elif [[ "$ext" == "holospy" && "${{ env.REPOSITORY_NAME }}" != "holospy" ]]; then
              pip install "holospy @ git+https://github.com/hyperspy/holospy.git"
            elif [[ "$ext" == "hyperspy-gui-ipywidgets" && "${{ env.REPOSITORY_NAME }}" != "hyperspy_gui_ipywidgets" ]]; then
              pip install "hyperspy-gui-ipywidgets @ git+https://github.com/hyperspy/hyperspy_gui_ipywidgets.git"
            elif [[ "$ext" == "hyperspy-gui-traitsui" && "${{ env.REPOSITORY_NAME }}" != "hyperspy_gui_traitsui" ]]; then
              pip install "hyperspy-gui-traitsui @ git+https://github.com/hyperspy/hyperspy_gui_traitsui.git"
            elif [[ "$ext" == "lumispy" && "${{ env.REPOSITORY_NAME }}" != "lumispy" ]]; then
              pip install "lumispy @ git+https://github.com/lumispy/lumispy.git"
            elif [[ "$ext" == "pyxem" && "${{ env.REPOSITORY_NAME }}" != "pyxem" ]]; then
              pip install "pyxem @ git+https://github.com/pyxem/pyxem.git"
            elif [[ "$ext" == "kikuchipy" && "${{ env.REPOSITORY_NAME }}" != "kikuchipy" ]]; then
              pip install "kikuchipy @ git+https://github.com/pyxem/kikuchipy.git"
            elif [[ "$ext" == "atomap" && "${{ env.REPOSITORY_NAME }}" != "atomap" ]]; then
              pip install "atomap @ git+https://github.com/atomap-dev/atomap.git"
            elif [[ "$ext" == "etspy" && "${{ env.REPOSITORY_NAME }}" != "etspy" ]]; then
              pip install "etspy @ git+https://github.com/usnistgov/etspy.git"
            else
              echo "Unknown extension: $ext"
              exit 1
            fi
          done

      - name: Conda list
        run: |
          conda list

      - name: Install ${{ env.REPOSITORY_NAME }} (local)
        if: ${{ inputs.INSTALL_SOURCE_FROM_REPOSITORY }}
        working-directory: ${{ github.workspace }}
        run: |
          pip install -e .${{ inputs.PIP_EXTRAS }}

      - name: Install pooch
        if: ${{ inputs.CACHE_POOCH != '' }}
        run: |
          if [[ "${{ inputs.USE_CONDA }}" == "true" ]]; then
            conda install pooch
          else
            pip install pooch
          fi

      - name: Get pooch cache paths
        if: ${{ inputs.CACHE_POOCH != '' }}
        run: |
          # create list of pooch cache paths as a string (space separated)
          python -c "import pooch; print(' '.join([str(pooch.os_cache(s)) for s in '${{ inputs.CACHE_POOCH }}'.split(' ')]))" > pooch_cache_paths.txt
          echo "POOCH_CACHE_PATHS=$(cat pooch_cache_paths.txt)" >> $GITHUB_ENV

      - name: Cache pooch data
        if: ${{ always() && inputs.CACHE_POOCH != '' }}
        uses: actions/cache@v4
        env:
          # Increase this value to reset cache
          CACHE_NUMBER: 0
        with:
          path: ${{ env.POOCH_CACHE_PATHS }}
          key: ${{ runner.os }}-${{ inputs.CACHE_POOCH_LABEL }}-${{ env.CACHE_NUMBER }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.CACHE_POOCH_LABEL }}-${{ env.CACHE_NUMBER }}

      - name: Conda list
        run: |
          conda list

      - name: Get rosettasciio tests data location
        if: ${{ env.REPOSITORY_NAME != 'rosettasciio' }} # only for repositories that are not rosettasciio
        run: |
          python -c "from rsciio.tests import registry; print(f'ROSETTASCIIO_TEST_DATA={str(registry.TESTS_PATH / \"data\") }')" >> $GITHUB_ENV

      - name: Cache rosettasciio data
        if: ${{ always() && env.REPOSITORY_NAME != 'rosettasciio' }} # only for repositories that are not rosettasciio
        uses: actions/cache@v4
        env:
          # Increase this value to reset cache
          CACHE_NUMBER: 0
        with:
          path: ${{ env.ROSETTASCIIO_TEST_DATA }}
          key:
            ${{ runner.os }}-integration-rosettasciio-${{ env.CACHE_NUMBER }}
          restore-keys: |
            ${{ runner.os }}-integration-rosettasciio-${{ env.CACHE_NUMBER }}

      - name: Download GOS data files
        if: ${{ contains(inputs.EXTENSIONS, 'exspy') && inputs.EXTENSION_VERSION == 'dev'}}
        # GOS files are needed for some hyperspy and hyperspy_gui_ipywidgets tests
        run: |
          python -c "from exspy._misc import _download_GOS_files; _download_GOS_files()"

      - name: Run HyperSpy Test Suite
        if: ${{ always() }}
        working-directory: ${{ runner.temp }}
        id: hyperspy_tests
        run: |
          # https://github.com/hyperspy/hyperspy/issues/3536
          # Fixed in https://github.com/hyperspy/hyperspy/pull/3554
          # skip test_missing_analytical_gradient and test_EELSModel_saving until exspy is released with the "_download_GOS_files" function
          pytest --pyargs hyperspy ${{ env.PYTEST_ARGS }} ${{ env.PYTEST_LOG_ARGS }} -k "not test_arpack and not map_values_std_isset and not test_missing_analytical_gradient and not test_EELSModel_saving"

      - name: Report HyperSpy test failures as GitHub Issue
        if: |
          failure()
          && inputs.REPORT_FAILURE_AS_ISSUE
          && github.repository == 'hyperspy/hyperspy-extensions-list'
          && steps.hyperspy_tests.outcome == 'failure'
        uses: scientific-python/issue-from-pytest-log-action@558a3dfdd251069b328d3fded994824ddbefc47b
        with:
          log-path: ${{ runner.temp }}/pytest-log.jsonl
          issue-title: ⚠️ HyperSpy test suite failed ⚠️
          assignees: "ericpre"

      - name: Run RosettaSciIO Test Suite
        if: ${{ always() }}
        working-directory: ${{ runner.temp }}
        run: |
          # mrcz doesn't support python 3.12 and above because of dependence on distutils
          # https://github.com/em-MRCZ/python-mrcz/pull/16
          # distutils is vendored in setuptools, which can be misleading 
          # pyusid doesn't support numpy 2
          pytest --pyargs rsciio ${{ env.PYTEST_ARGS }} -k "not test_mrcz.py and not test_usid.py"

      - name: Run LumiSpy Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'lumispy')}}
        working-directory: ${{ runner.temp }}
        run: |
          pytest --pyargs lumispy

      - name: Run hyperspy_gui_ipywidgets Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'hyperspy-gui-ipywidgets') }}
        working-directory: ${{ runner.temp }}
        run: |
          # until exspy is released with the "_download_GOS_files" function
          pytest --pyargs hyperspy_gui_ipywidgets -k "not test_eels_component"

      - name: Run hyperspy_gui_traitsui Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'hyperspy-gui-traitsui') }}
        working-directory: ${{ runner.temp }}
        run: |
          pytest --pyargs hyperspy_gui_traitsui

      - name: Run Pyxem Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'pyxem') }}
        working-directory: ${{ runner.temp }}
        run: |
          # https://github.com/pyxem/pyxem/issues/1153
          # https://github.com/pyxem/pyxem/issues/1174
          # test_load_au_grating: skip to avoid hitting rate limits from zenodo
          pytest --pyargs pyxem -k "not TestAddEllipseArrayAsMarkers and not test_ransac_ellipse_tools and not test_load_au_grating"

      - name: Run holospy Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'holospy') }}
        working-directory: ${{ runner.temp }}
        run: |
          pytest --pyargs holospy

      - name: Run exSpy Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'exspy') && inputs.EXTENSION_VERSION == 'dev' }}
        working-directory: ${{ runner.temp }}
        run: |
          pytest --pyargs exspy -n 2

      - name: Run kikuchipy Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'kikuchipy') }}
        working-directory: ${{ runner.temp }}
        run: |
          # https://github.com/pyxem/kikuchipy/issues/707
          # https://github.com/pyxem/kikuchipy/pull/749
          # test_dataset_availability: don't test dataset availability to avoid hitting rate limits from zenodo
          pytest --pyargs kikuchipy -k "not test_not_allow_download_raises and not spherical and not test_dataset_availability"

      - name: Run etspy Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'etspy') }}
        working-directory: ${{ runner.temp }}
        run: |
          # https://github.com/usnistgov/etspy/issues/24
          pytest --pyargs etspy -k "not test_version"

      - name: Run atomap Test Suite
        if: ${{ always() && contains(inputs.EXTENSIONS, 'atomap') }}
        working-directory: ${{ runner.temp }}
        run: |
          # don't run tests that require a gui
          # https://github.com/atomap-dev/atomap/pull/2
          pytest --pyargs atomap -k "not test_gui_function_qt"

      - name: Show content of all pooch caches
        if: ${{ always() && inputs.CACHE_POOCH != '' }}
        run: |
          for cache_path in ${{ env.POOCH_CACHE_PATHS }}; do
            echo "Contents of pooch cache path: $cache_path"
            ls -lR $cache_path || echo "Pooch cache path $cache_path does not exist."
          done
